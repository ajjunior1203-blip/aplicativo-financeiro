{% extends "base.html" %}
{% block title %}Ver Orçamentos{% endblock %}
{% block page_title %}Orçamentos Cadastrados{% endblock %}
{% block content %}

<!-- Filtro por mês -->
<form id="filtro-form" style="margin-bottom: 20px;">
  <label for="mes">Filtrar por mês:</label>
  <select name="mes" id="mes">
    <option value="">Todos os meses</option>
    {% for m in ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"] %}
      <option value="{{ m }}">{{ m|capitalize }}</option>
    {% endfor %}
  </select>
</form>

<table style="width: 100%; border-collapse: collapse;">
  <thead>
    <tr>
      <th style="text-align: left;">Categoria</th>
      <th style="text-align: center;">Mês</th>
      <th style="text-align: right;">Valor (R$)</th>
      <th style="text-align: center;">Ações</th>
    </tr>
  </thead>
  <tbody id="orcamentos-tabela">
    {% for o in orcamentos %}
    <tr data-mes="{{ o.mes }}" id="linha-{{ o.id }}">
      <td><span id="cat-{{ o.id }}">{{ o.categoria }}</span></td>
      <td style="text-align: center;"><span id="mes-{{ o.id }}">{{ o.mes|capitalize }}</span></td>
      <td style="text-align: right;">
        <span id="val-{{ o.id }}">{{ "%.2f"|format(o.valor)|replace(".", ",") }}</span>
        <input type="text" id="val-edit-{{ o.id }}" style="display:none; text-align:right;" placeholder="R$ 0,00">
      </td>
      <td style="text-align: center;">
  <button onclick="iniciarEdicao('{{ o.id }}')" id="btn-editar-{{ o.id }}" class="btn-acao" title="Editar">
    <i class="fa-solid fa-pen-to-square"></i>
  </button>

  <button onclick="salvarEdicao('{{ o.id }}')" style="display:none;" id="btn-salvar-{{ o.id }}" class="btn-acao" title="Salvar">
    <i class="fa-solid fa-floppy-disk"></i>
  </button>

  <button onclick="excluirOrcamento('{{ o.id }}')" class="btn-acao" title="Excluir">
    <i class="fa-solid fa-trash-can"></i>
  </button>
</td>

      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  // Filtro por mês
  document.getElementById("mes").addEventListener("change", function () {
    const mesSelecionado = this.value;
    const linhas = document.querySelectorAll("#orcamentos-tabela tr");
    linhas.forEach(linha => {
      const mes = linha.getAttribute("data-mes");
      linha.style.display = (!mesSelecionado || mes === mesSelecionado) ? "" : "none";
    });
  });

  // Exclusão
  function excluirOrcamento(id) {
  const confirmar = confirm("Tem certeza que deseja excluir este orçamento?");
  if (!confirmar) return;

  const formData = new FormData();
  formData.append("orcamento_id", id);
  fetch("/excluir_orcamento", {
    method: "POST",
    body: formData
  }).then(res => res.json()).then(data => {
    if (data.status === "ok") {
      location.reload();
    } else {
      alert("Erro ao excluir orçamento.");
    }
  });
}

  // Iniciar edição
  function iniciarEdicao(id) {
    document.getElementById("val-" + id).style.display = "none";
    const input = document.getElementById("val-edit-" + id);
    input.style.display = "inline-block";
    input.value = "R$ " + document.getElementById("val-" + id).innerText;
    input.focus();

    document.getElementById("btn-editar-" + id).style.display = "none";
    document.getElementById("btn-salvar-" + id).style.display = "inline-block";
  }

  // Salvar edição com categoria e mês fixos
  function salvarEdicao(id) {
    const input = document.getElementById("val-edit-" + id);
    const valorTexto = input.value.replace(/\D/g, "");
    const valor = parseFloat(valorTexto.replace(/^0+/, "").padStart(3, "0").replace(/(\d+)(\d{2})$/, "$1.$2"));

    const categoria = document.getElementById("cat-" + id).innerText.trim();
    const mes = document.getElementById("mes-" + id).innerText.trim().toLowerCase();

    const formData = new FormData();
    formData.append("orcamento_id", id);
    formData.append("valor", valor);
    formData.append("categoria", categoria);
    formData.append("mes", mes);

    fetch("/editar_orcamento", {
      method: "POST",
      body: formData
    }).then(res => res.json()).then(data => {
      if (data.status === "ok") {
        location.reload();
      } else {
        alert("Erro ao editar orçamento.");
      }
    }).catch(() => {
      alert("Erro de conexão.");
    });
  }

  // Formatação bancária durante digitação
  document.querySelectorAll("input[id^='val-edit-']").forEach(input => {
    input.addEventListener("input", function () {
      let valor = this.value.replace(/\D/g, "");
      valor = valor.replace(/^0+/, "");
      if (valor.length < 3) valor = valor.padStart(3, "0");
      const centavos = valor.slice(-2);
      const reais = valor.slice(0, -2);
      const reaisFormatado = reais.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      this.value = `R$ ${reaisFormatado},${centavos}`;
    });
  });
</script>

{% endblock %}
