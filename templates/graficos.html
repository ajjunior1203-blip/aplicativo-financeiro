{% extends "base.html" %}
{% block title %}Gráficos Financeiros{% endblock %}
{% block page_title %}Painel de Gráficos{% endblock %}
{% block content %}

<form id="filtro-grafico" style="margin-bottom: 20px;">
  <label for="mes">Mês:</label>
  <select id="mes" name="mes">
    {% for m in ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"] %}
      <option value="{{ m }}">{{ m|capitalize }}</option>
    {% endfor %}
  </select>

  <label for="ano">Ano:</label>
  <select id="ano" name="ano">
    {% for a in [2025, 2026, 2027] %}
      <option value="{{ a }}">{{ a }}</option>
    {% endfor %}
  </select>

  <button type="submit">Atualizar</button>
</form>

<div style="width: 100%; max-width: 400px; margin: auto;">
  <canvas id="graficoResumoMensal" style="width: 100%; height: 240px;"></canvas>
</div>

<h3>Orçado x Realizado</h3>
<div id="categorias-comparativo"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
  const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho",
                 "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];

  let graficoAtual = null;

  document.getElementById("filtro-grafico").addEventListener("submit", function (e) {
    e.preventDefault();
    carregarDados();
  });

  function carregarDados() {
    const mes = document.getElementById("mes").value;
    const ano = document.getElementById("ano").value;

    fetch(`/dados_graficos?mes=${mes}&ano=${ano}`)
      .then(res => res.json())
      .then(data => {
        atualizarGrafico(data.resumo, mes, ano);
        atualizarCategorias(data.categorias);
      });
  }

  function atualizarGrafico(resumo, mes, ano) {
    const canvas = document.getElementById("graficoResumoMensal");
    if (canvas) {
      const ctx = canvas.getContext("2d");

      if (graficoAtual) {
        graficoAtual.destroy();
      }

      const saldo = resumo.entradas - resumo.saidas;

      graficoAtual = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Entradas", "Orçado", "Gastos", "Montante", "Saldo de Caixa"],
          datasets: [{
            data: [resumo.entradas, resumo.orcado, resumo.saidas, resumo.montantes, saldo],
            backgroundColor: ["#2196f3", "#4caf50", "#f44336", "#ff9800", "#9c27b0"]
          }]
        },
        options: {
          layout: {
            padding: { top: 30 }
          },
          plugins: {
            legend: { display: false },
            datalabels: {
              anchor: "end",
              align: "top",
              formatter: (value) => value.toLocaleString("pt-BR", {
                style: "currency",
                currency: "BRL"
              }),
              font: { weight: "bold", size: 12 },
              color: "#000",
              clip: false
            }
          },
          scales: {
            y: {
              display: false,
              beginAtZero: true
            },
            x: {
              ticks: {
                font: { weight: "bold", size: 12 },
                color: "#000"
              },
              grid: {
                drawOnChartArea: false,
                drawTicks: false
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }
  }

  function atualizarCategorias(categorias) {
    const container = document.getElementById("categorias-comparativo");
    container.innerHTML = "";

    categorias.forEach(cat => {
      const porcentagem = Math.min((cat.gasto / cat.orcado) * 100, 100);
      const barra = `
        <div style="margin-bottom: 10px;">
          <strong>${cat.nome}:</strong> R$ ${cat.gasto.toFixed(2)} / R$ ${cat.orcado.toFixed(2)}
          <div style="background:#ddd; height:10px; width:300px; margin-top:4px;">
            <div style="background:${cat.gasto > cat.orcado ? '#f44336' : '#4caf50'}; height:10px; width:${porcentagem * 3}px;"></div>
          </div>
        </div>
      `;
      container.innerHTML += barra;
    });
  }

  // Inicializa com mês atual
  const hoje = new Date();
  document.getElementById("mes").value = meses[hoje.getMonth()];
  document.getElementById("ano").value = hoje.getFullYear();
  carregarDados();
</script>

{% endblock %}
